# Универсальная авторизация для Parsifal

Этот документ описывает настройку универсальной системы авторизации, которая работает как в веб-версии, так и в iOS приложении.

## Обзор решения

Система использует веб-компонент для авторизации, который:
1. **В веб-версии** - работает как обычная веб-страница
2. **В iOS** - открывает браузер для авторизации, затем возвращает токен через Custom URL Scheme

## Компоненты системы

### 1. UniversalAuthComponent
- Основной компонент авторизации
- Автоматически определяет платформу (веб/iOS)
- Для iOS открывает браузер с callback URL
- Для веба использует стандартный подход

### 2. AuthCallbackComponent
- Обрабатывает возврат из браузера
- Извлекает токен из URL параметров
- Перенаправляет на главную страницу

### 3. CustomUrlSchemeService
- Обрабатывает Custom URL Scheme в iOS
- Слушает события открытия приложения по URL
- Обрабатывает токены авторизации

## Настройка iOS

### 1. Info.plist
Добавлен Custom URL Scheme `parsifal://`:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLName</key>
        <string>parsifal.auth</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>parsifal</string>
        </array>
    </dict>
</array>
```

### 2. Маршруты
Добавлены новые маршруты:
- `/auth` - страница авторизации
- `/auth/callback` - обработка callback

## Как это работает

### Веб-версия
1. Пользователь переходит на `/auth`
2. Нажимает кнопку "Войти через Яндекс"
3. Происходит редирект на OAuth страницу Яндекса
4. После авторизации редирект на `/auth/callback`
5. Токен извлекается и обрабатывается
6. Перенаправление на главную страницу

### iOS версия
1. Пользователь нажимает "Войти через Яндекс"
2. Открывается браузер с OAuth страницей Яндекса
3. После авторизации браузер пытается перейти на `parsifal://auth/callback`
4. iOS открывает приложение по этому URL
5. CustomUrlSchemeService обрабатывает URL
6. Токен извлекается и обрабатывается
7. Перенаправление на главную страницу

## Настройка Яндекс OAuth

В настройках приложения Яндекса нужно добавить:
- **Redirect URI для веба**: `https://yourdomain.com/auth/callback`
- **Redirect URI для iOS**: `parsifal://auth/callback`

## Тестирование

### Веб
1. Перейдите на `/auth`
2. Нажмите "Войти через Яндекс"
3. Проверьте, что происходит редирект и возврат

### iOS
1. Запустите приложение на устройстве
2. Перейдите на страницу авторизации
3. Нажмите "Войти через Яндекс"
4. Проверьте, что браузер открывается и приложение возвращается с токеном

## Возможные проблемы

### 1. Токен не передается
- Проверьте настройки OAuth в Яндексе
- Убедитесь, что redirect_uri совпадает
- Проверьте логи в консоли

### 2. iOS не открывается по URL
- Проверьте Info.plist
- Убедитесь, что CFBundleURLSchemes настроен правильно
- Пересоберите приложение

### 3. Браузер не закрывается
- Это нормальное поведение для iOS
- Приложение автоматически получит токен через Custom URL Scheme

## Безопасность

- Все токены передаются через HTTPS
- Custom URL Scheme уникален для приложения
- Токены не сохраняются в localStorage без шифрования
- Используется стандартный OAuth 2.0 flow

## Дальнейшее развитие

1. Добавить поддержку других провайдеров (Google, Facebook)
2. Реализовать refresh token механизм
3. Добавить биометрическую аутентификацию
4. Реализовать двухфакторную аутентификацию
